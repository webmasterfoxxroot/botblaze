<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuracoes - BotBlaze</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ── SECTION CARDS ───────────────────────────────── */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; }
        .settings-card-full { grid-column: 1 / -1; }

        .card-title { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
        .card-title-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .card-title-icon svg { width: 18px; height: 18px; }
        .card-title h2 { font-size: 15px; font-weight: 700; }
        .card-title p { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .icon-red { background: rgba(230,57,70,.12); color: #e63946; }
        .icon-blue { background: rgba(88,166,255,.12); color: #58a6ff; }
        .icon-green { background: rgba(46,204,113,.12); color: #2ecc71; }
        .icon-gold { background: rgba(210,153,34,.12); color: #d29922; }

        /* ── FORM IMPROVEMENTS ───────────────────────────── */
        .field { margin-bottom: 18px; }
        .field:last-child { margin-bottom: 0; }
        .field-label { display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
        .field-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .field-input { width: 100%; padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 14px; transition: border-color .2s; }
        .field-input:focus { outline: none; border-color: var(--accent); }
        select.field-input { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b949e' stroke-width='2' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }

        /* ── TOGGLE SWITCH ────────────────────────────────── */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,.04); }
        .toggle-row:last-child { border-bottom: none; padding-bottom: 0; }
        .toggle-row:first-child { padding-top: 0; }
        .toggle-info { flex: 1; }
        .toggle-label { font-size: 14px; font-weight: 600; }
        .toggle-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

        .toggle { position: relative; width: 44px; height: 24px; flex-shrink: 0; margin-left: 16px; }
        .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-track { position: absolute; inset: 0; background: rgba(255,255,255,.1); border-radius: 12px; cursor: pointer; transition: background .2s; }
        .toggle-track::after { content: ''; position: absolute; width: 18px; height: 18px; border-radius: 50%; background: #fff; top: 3px; left: 3px; transition: transform .2s; box-shadow: 0 1px 3px rgba(0,0,0,.2); }
        .toggle input:checked + .toggle-track { background: var(--accent); }
        .toggle input:checked + .toggle-track::after { transform: translateX(20px); }

        /* ── INLINE FIELDS ────────────────────────────────── */
        .fields-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

        /* ── SAVE AREA ────────────────────────────────────── */
        .save-bar { display: flex; align-items: center; justify-content: center; gap: 16px; margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--border); }
        .save-btn { padding: 12px 40px; border-radius: 10px; border: none; background: var(--accent); color: #fff; font-size: 15px; font-weight: 700; cursor: pointer; transition: all .2s; display: flex; align-items: center; gap: 8px; }
        .save-btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
        .save-btn:disabled { opacity: .5; cursor: default; transform: none; }
        .save-btn svg { width: 18px; height: 18px; }

        /* ── TOAST ────────────────────────────────────────── */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 10px; color: #fff; font-size: 13px; font-weight: 600; z-index: 2000; display: flex; align-items: center; gap: 8px; box-shadow: 0 8px 24px rgba(0,0,0,.2); animation: toastIn .3s ease; }
        .toast-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .toast-error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media (max-width: 768px) {
            .settings-grid { grid-template-columns: 1fr; }
            .fields-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">BotBlaze</a>
        <ul class="navbar-nav">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="settings.html">Configuracoes</a></li>
            <li id="admin-link" style="display:none;"><a href="admin.html">Admin</a></li>
            <li><a href="#" id="logout-btn">Sair</a></li>
        </ul>
    </nav>

    <div class="container dashboard">
        <div class="page-header">
            <h1>Configuracoes do Bot</h1>
        </div>

        <div class="settings-grid">
            <!-- Aposta -->
            <div class="settings-card">
                <div class="card-title">
                    <div class="card-title-icon icon-red">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <div>
                        <h2>Aposta</h2>
                        <p>Valor e estrategia de aposta</p>
                    </div>
                </div>

                <div class="field">
                    <label class="field-label">Valor da Aposta (R$)</label>
                    <input type="text" id="bet_amount" class="field-input" inputmode="decimal" placeholder="2,00" value="2,00">
                    <p class="field-hint">Valor base de cada aposta (ex: 3,50)</p>
                </div>

                <div class="field">
                    <label class="field-label">Nivel de Agressividade</label>
                    <select id="strategy" class="field-input">
                        <option value="conservador">Conservador - Aposta pouco, mais seguro</option>
                        <option value="moderado" selected>Moderado - Equilibrado (recomendado)</option>
                        <option value="agressivo">Agressivo - Aposta mais, mais risco</option>
                    </select>
                    <p class="field-hint" id="strategy-hint">O bot analisa 7 padroes e so aposta quando tem confianca suficiente</p>
                </div>

                <div class="field">
                    <label class="field-label">Max Apostas por Dia</label>
                    <input type="number" id="max_bets_per_day" class="field-input" min="1" max="500" value="50">
                    <p class="field-hint">Limite diario de apostas automaticas</p>
                </div>
            </div>

            <!-- Analise Inteligente -->
            <div class="settings-card">
                <div class="card-title">
                    <div class="card-title-icon icon-blue">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    </div>
                    <div>
                        <h2>Analise Inteligente</h2>
                        <p>7 analisadores de padroes combinados</p>
                    </div>
                </div>

                <div class="field">
                    <label class="field-label">Confianca Minima (%)</label>
                    <input type="number" id="min_confidence" class="field-input" min="30" max="90" step="5" value="60">
                    <p class="field-hint">So aposta quando a confianca combinada dos sinais atinge este valor. Maior = mais seguro, menos apostas.</p>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <div class="toggle-label">Apostar no Branco (x14)</div>
                        <div class="toggle-desc">Permite apostar no branco quando o intervalo esta muito alto. Raro mas paga 14x.</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="bet_white" checked>
                        <span class="toggle-track"></span>
                    </label>
                </div>

                <div style="margin-top: 16px; background: rgba(255,255,255,.03); border-radius: 10px; padding: 14px;">
                    <p style="font-size: 12px; font-weight: 700; margin-bottom: 10px; color: var(--text);">Como funciona:</p>
                    <div style="font-size: 11px; color: var(--text-muted); line-height: 1.7;">
                        <div style="display:flex;gap:8px;margin-bottom:4px;"><span style="color:#ef4444;flex-shrink:0;">1.</span> <b>Sequencia</b> - 3+ da mesma cor seguida, aposta na oposta</div>
                        <div style="display:flex;gap:8px;margin-bottom:4px;"><span style="color:#ef4444;flex-shrink:0;">2.</span> <b>Alternancia</b> - Detecta padrao R-B-R-B e continua</div>
                        <div style="display:flex;gap:8px;margin-bottom:4px;"><span style="color:#ef4444;flex-shrink:0;">3.</span> <b>Frequencia</b> - Aposta na cor que menos apareceu (20 jogos)</div>
                        <div style="display:flex;gap:8px;margin-bottom:4px;"><span style="color:#ef4444;flex-shrink:0;">4.</span> <b>Pares</b> - Detecta padrao RR-BB-RR de pares</div>
                        <div style="display:flex;gap:8px;margin-bottom:4px;"><span style="color:#fbbf24;flex-shrink:0;">5.</span> <b>Branco</b> - Preve quando o branco esta atrasado</div>
                        <div style="display:flex;gap:8px;margin-bottom:4px;"><span style="color:#ef4444;flex-shrink:0;">6.</span> <b>Ausencia</b> - Cor que nao aparece ha 5+ rodadas</div>
                        <div style="display:flex;gap:8px;"><span style="color:#ef4444;flex-shrink:0;">7.</span> <b>Tendencia</b> - Compara ultimos 5 vs anteriores 5</div>
                    </div>
                    <p style="font-size: 11px; color: var(--accent); margin-top: 10px;">Cada analisador vota em uma cor com uma confianca. O bot so aposta quando os sinais concordam.</p>
                </div>
            </div>

            <!-- Martingale -->
            <div class="settings-card">
                <div class="card-title">
                    <div class="card-title-icon" style="background:rgba(139,92,246,.12);color:#8b5cf6;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                    </div>
                    <div>
                        <h2>Martingale</h2>
                        <p>Dobra a aposta apos perda</p>
                    </div>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <div class="toggle-label">Ativar Martingale</div>
                        <div class="toggle-desc">Dobra automaticamente apos cada perda</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="martingale_enabled">
                        <span class="toggle-track"></span>
                    </label>
                </div>

                <div style="margin-top: 18px;">
                    <div class="field">
                        <label class="field-label">Niveis Maximo</label>
                        <input type="number" id="martingale_max" class="field-input" min="1" max="10" value="3">
                        <p class="field-hint">Quantas vezes dobrar antes de parar (ex: 3 = aposta ate 3x)</p>
                    </div>

                    <div class="field">
                        <label class="field-label">Multiplicador</label>
                        <input type="number" id="martingale_multiplier" class="field-input" min="1.5" max="5.0" step="0.1" value="2.0">
                        <p class="field-hint">Fator de multiplicacao apos perda (padrao: 2x)</p>
                    </div>
                </div>
            </div>

            <!-- Limites -->
            <div class="settings-card settings-card-full">
                <div class="card-title">
                    <div class="card-title-icon icon-gold">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    </div>
                    <div>
                        <h2>Limites de Seguranca</h2>
                        <p>Protecao contra perdas excessivas</p>
                    </div>
                </div>

                <div class="fields-row">
                    <div class="field">
                        <label class="field-label">Stop Loss (R$)</label>
                        <input type="number" id="stop_loss" class="field-input" min="1" max="10000" step="1" value="50">
                        <p class="field-hint">Bot para ao perder este valor no dia</p>
                    </div>
                    <div class="field">
                        <label class="field-label">Stop Gain (R$)</label>
                        <input type="number" id="stop_gain" class="field-input" min="1" max="10000" step="1" value="100">
                        <p class="field-hint">Bot para ao lucrar este valor no dia</p>
                    </div>
                </div>
            </div>

            <!-- Automacao -->
            <div class="settings-card settings-card-full">
                <div class="card-title">
                    <div class="card-title-icon icon-green">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/><path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/><path d="M12 2v2"/><path d="M12 22v-2"/><path d="m17 20.66-1-1.73"/><path d="M11 10.27 7 3.34"/><path d="m20.66 17-1.73-1"/><path d="m3.34 7 1.73 1"/><path d="M14 12h8"/><path d="M2 12h2"/><path d="m20.66 7-1.73 1"/><path d="m3.34 17 1.73-1"/><path d="m17 3.34-1 1.73"/><path d="m11 13.73-4 6.93"/></svg>
                    </div>
                    <div>
                        <h2>Automacao</h2>
                        <p>Controle do bot automatico</p>
                    </div>
                </div>

                <div class="toggle-row">
                    <div class="toggle-info">
                        <div class="toggle-label">Bot Automatico</div>
                        <div class="toggle-desc">Apostar automaticamente quando detectar oportunidade</div>
                    </div>
                    <label class="toggle">
                        <input type="checkbox" id="auto_bet" checked>
                        <span class="toggle-track"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Save -->
        <div class="save-bar">
            <button class="save-btn" id="save-btn" onclick="saveSettings()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg>
                Salvar Configuracoes
            </button>
        </div>
    </div>

    <footer class="footer">
        <p>BotBlaze &copy; 2026</p>
    </footer>

    <script>
    const API_URL = window.location.origin + '/api';
    const token = localStorage.getItem('botblaze_token');
    const user = JSON.parse(localStorage.getItem('botblaze_user') || '{}');
    if (!token) window.location.href = '/login.html';

    if (user.role === 'admin') document.getElementById('admin-link').style.display = '';

    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('botblaze_token');
        localStorage.removeItem('botblaze_user');
        window.location.href = '/login.html';
    });

    function showToast(msg, type) {
        const el = document.createElement('div');
        el.className = 'toast toast-' + type;
        el.innerHTML = (type === 'success' ? '&#10003;' : '&#10007;') + ' ' + msg;
        document.body.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 2500);
    }

    // ── LOAD SETTINGS ───────────────────────────────────────────────────────────

    async function loadSettings() {
        try {
            const res = await fetch(API_URL + '/settings.php', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            if (data.settings) {
                const s = data.settings;
                document.getElementById('bet_amount').value = formatBRL(s.bet_amount || 2);
                document.getElementById('strategy').value = s.strategy || 'moderado';
                document.getElementById('min_confidence').value = s.min_confidence || 60;
                document.getElementById('bet_white').checked = s.bet_white !== false && s.bet_white !== 0;
                document.getElementById('martingale_enabled').checked = !!s.martingale_enabled;
                document.getElementById('martingale_max').value = s.martingale_max || 3;
                document.getElementById('martingale_multiplier').value = s.martingale_multiplier || 2.0;
                document.getElementById('stop_loss').value = s.stop_loss || 50;
                document.getElementById('stop_gain').value = s.stop_gain || 100;
                document.getElementById('max_bets_per_day').value = s.max_bets_per_day || 50;
                document.getElementById('auto_bet').checked = !!s.auto_bet;
                updateStrategyHint();
            }
        } catch (err) {
            console.error('Erro:', err);
        }
    }

    // ── SAVE SETTINGS ───────────────────────────────────────────────────────────

    async function saveSettings() {
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;animation:spin 1s linear infinite"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Salvando...';

        const settings = {
            bet_amount: parseBRL(document.getElementById('bet_amount').value),
            strategy: document.getElementById('strategy').value,
            min_confidence: parseInt(document.getElementById('min_confidence').value),
            bet_white: document.getElementById('bet_white').checked ? 1 : 0,
            martingale_enabled: document.getElementById('martingale_enabled').checked ? 1 : 0,
            martingale_max: parseInt(document.getElementById('martingale_max').value),
            martingale_multiplier: parseFloat(document.getElementById('martingale_multiplier').value),
            stop_loss: parseFloat(document.getElementById('stop_loss').value),
            stop_gain: parseFloat(document.getElementById('stop_gain').value),
            max_bets_per_day: parseInt(document.getElementById('max_bets_per_day').value),
            auto_bet: document.getElementById('auto_bet').checked ? 1 : 0
        };

        try {
            const res = await fetch(API_URL + '/settings.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify(settings)
            });
            const data = await res.json();

            if (data.error) {
                showToast(data.error, 'error');
            } else {
                showToast('Configuracoes salvas com sucesso!', 'success');
            }
        } catch (err) {
            showToast('Erro de conexao', 'error');
        }

        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><path d="M17 21v-8H7v8"/><path d="M7 3v5h8"/></svg> Salvar Configuracoes';
    }

    // ── STRATEGY HINTS ──────────────────────────────────────────────────────────

    const strategyHints = {
        conservador: 'Confianca minima 75%. Pula mais rodadas, aposta so em sinais fortes. Ideal para proteger banca.',
        moderado: 'Confianca minima 60%. Equilibrio entre seguranca e frequencia de apostas. Recomendado para a maioria.',
        agressivo: 'Confianca minima 45%. Aposta com mais frequencia, aceita sinais mais fracos. Maior risco e potencial retorno.'
    };

    const strategyConfidence = { conservador: 75, moderado: 60, agressivo: 45 };

    function updateStrategyHint() {
        const val = document.getElementById('strategy').value;
        const hint = document.getElementById('strategy-hint');
        const confInput = document.getElementById('min_confidence');
        if (hint && strategyHints[val]) hint.textContent = strategyHints[val];
        if (confInput && strategyConfidence[val]) confInput.value = strategyConfidence[val];
    }

    document.getElementById('strategy').addEventListener('change', updateStrategyHint);

    // ── FORMATADORES BR ──────────────────────────────────────────────────────────

    function parseBRL(val) {
        if (typeof val === 'number') return val;
        val = String(val).trim().replace(/R\$/g, '').replace(/\s/g, '');
        if (val.includes(',')) val = val.replace(/\./g, '').replace(',', '.');
        const num = parseFloat(val);
        return isNaN(num) ? 2 : num;
    }

    function formatBRL(val) {
        val = parseFloat(val);
        if (isNaN(val)) return '2,00';
        return val.toFixed(2).replace('.', ',');
    }

    loadSettings();
    </script>

    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</body>
</html>
