<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - BotBlaze</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">BotBlaze</a>
        <ul class="navbar-nav">
            <li><a href="admin.html">Admin</a></li>
            <li><a href="#" id="logout-btn">Sair</a></li>
        </ul>
    </nav>

    <div class="container dashboard">
        <h1>Painel Admin</h1>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="s-users">0</div>
                <div class="stat-label">Usuarios</div>
            </div>
            <div class="stat-card stat-green">
                <div class="stat-value" id="s-subs">0</div>
                <div class="stat-label">Assinantes Ativos</div>
            </div>
            <div class="stat-card stat-gold">
                <div class="stat-value" id="s-revenue">R$ 0</div>
                <div class="stat-label">Receita Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="s-bets">0</div>
                <div class="stat-label">Apostas Hoje</div>
            </div>
        </div>

        <!-- Users -->
        <div class="card">
            <div class="card-header">
                <h2>Usuarios</h2>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Plano</th>
                            <th>Expira</th>
                            <th>Cadastro</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr><td colspan="7" style="text-align:center; color: var(--text-muted);">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>BotBlaze Admin &copy; 2026</p>
    </footer>

    <script>
    const API_URL = window.location.origin + '/api';
    const token = localStorage.getItem('botblaze_token');
    const user = JSON.parse(localStorage.getItem('botblaze_user') || '{}');

    if (!token || user.role !== 'admin') {
        window.location.href = '/login.html';
    }

    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('botblaze_token');
        localStorage.removeItem('botblaze_user');
        window.location.href = '/login.html';
    });

    async function loadAdmin() {
        try {
            const res = await fetch(API_URL + '/admin.php', {
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();

            if (data.error) {
                window.location.href = '/login.html';
                return;
            }

            // Stats
            const s = data.stats;
            document.getElementById('s-users').textContent = s.total_users;
            document.getElementById('s-subs').textContent = s.active_subs;
            document.getElementById('s-revenue').textContent = 'R$ ' + parseFloat(s.revenue).toFixed(2).replace('.', ',');
            document.getElementById('s-bets').textContent = s.today_bets;

            // Users table
            const tbody = document.getElementById('users-table');
            if (data.users && data.users.length > 0) {
                tbody.innerHTML = data.users.map(u => {
                    const statusClass = u.status === 'active' ? 'badge-green' : 'badge-red';
                    const statusText = u.status === 'active' ? 'Ativo' : 'Bloqueado';
                    const plan = u.plan_name || 'Sem plano';
                    const expires = u.expires_at ? new Date(u.expires_at).toLocaleDateString('pt-BR') : '-';
                    const created = new Date(u.created_at).toLocaleDateString('pt-BR');
                    return `<tr>
                        <td>${u.id}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>${plan}</td>
                        <td>${expires}</td>
                        <td>${created}</td>
                    </tr>`;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--text-muted);">Nenhum usuario</td></tr>';
            }
        } catch (err) {
            console.error('Erro ao carregar admin:', err);
        }
    }

    loadAdmin();
    setInterval(loadAdmin, 30000);
    </script>
</body>
</html>
