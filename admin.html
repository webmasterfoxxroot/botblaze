<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - BotBlaze</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ── FILTER DROPDOWN ─────────────────────────────── */
        .filter-dropdown { position: relative; }
        .filter-btn { display: flex; align-items: center; gap: 10px; padding: 10px 16px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text); cursor: pointer; font-size: 14px; font-weight: 500; transition: all .2s; min-width: 200px; }
        .filter-btn:hover { border-color: rgba(255,255,255,.15); }
        .filter-btn.open { border-color: var(--accent); }
        .filter-btn-label { flex: 1; text-align: left; }
        .filter-btn-count { font-size: 12px; padding: 2px 8px; border-radius: 8px; background: var(--accent); color: #fff; font-weight: 600; min-width: 22px; text-align: center; }
        .filter-btn-arrow { transition: transform .2s; opacity: .5; }
        .filter-btn.open .filter-btn-arrow { transform: rotate(180deg); }
        .filter-menu { display: none; position: absolute; left: 0; top: calc(100% + 6px); background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 6px; min-width: 220px; z-index: 200; box-shadow: 0 12px 32px rgba(0,0,0,.4); }
        .filter-menu.open { display: block; animation: menuFade .15s ease; }
        .filter-option { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: 8px; border: none; background: none; color: var(--text); cursor: pointer; font-size: 13px; width: 100%; text-align: left; transition: background .1s; }
        .filter-option:hover { background: rgba(255,255,255,.06); }
        .filter-option.active { background: rgba(231,76,60,.1); color: var(--accent); }
        .filter-option svg { opacity: .4; flex-shrink: 0; }
        .filter-option.active svg { opacity: 1; color: var(--accent); }
        .filter-option-label { flex: 1; }
        .filter-option-count { font-size: 11px; color: var(--text-muted); padding: 2px 7px; border-radius: 6px; background: rgba(255,255,255,.06); }
        .filter-option.active .filter-option-count { background: rgba(231,76,60,.15); color: var(--accent); }
        .filter-sep { height: 1px; background: var(--border); margin: 4px 0; }

        /* ── SEARCH ───────────────────────────────────────── */
        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
        .search-wrap { position: relative; flex: 1; max-width: 360px; }
        .search-wrap svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: .4; }
        .search-field { width: 100%; padding: 10px 14px 10px 38px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-input); color: var(--text); font-size: 14px; transition: border .2s; }
        .search-field:focus { outline: none; border-color: var(--accent); }
        .search-field::placeholder { color: var(--text-muted); }
        .result-count { color: var(--text-muted); font-size: 13px; margin-left: auto; }

        /* ── USER CARDS LIST ──────────────────────────────── */
        .user-list { display: flex; flex-direction: column; gap: 2px; }
        .user-row { display: grid; grid-template-columns: 44px 1fr 1fr auto auto auto 40px; gap: 16px; align-items: center; padding: 14px 16px; border-radius: 10px; transition: background .15s; }
        .user-row:hover { background: rgba(255,255,255,.03); }
        .user-row.is-admin { border-left: 3px solid var(--accent); background: rgba(231,76,60,.03); }

        /* Avatar */
        .avatar { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; text-transform: uppercase; flex-shrink: 0; }
        .avatar-admin { background: linear-gradient(135deg, #e74c3c, #c0392b); color: #fff; }
        .avatar-user { background: linear-gradient(135deg, rgba(255,255,255,.1), rgba(255,255,255,.05)); color: var(--text-muted); }

        /* User info */
        .user-info { min-width: 0; }
        .user-name { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .user-email { font-size: 12px; color: var(--text-muted); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .tag { padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .5px; }
        .tag-admin { background: var(--accent); color: #fff; }
        .tag-you { background: rgba(52,152,219,.2); color: #3498db; }

        /* Plan info */
        .plan-info { min-width: 0; }
        .plan-name { font-size: 13px; font-weight: 600; }
        .plan-expires { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
        .plan-none { font-size: 13px; color: var(--text-muted); font-style: italic; }

        /* Status */
        .status-dot { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; }
        .status-dot::before { content: ''; width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .status-active::before { background: #2ecc71; box-shadow: 0 0 6px rgba(46,204,113,.4); }
        .status-blocked::before { background: #e74c3c; box-shadow: 0 0 6px rgba(231,76,60,.4); }

        /* Date */
        .date-cell { font-size: 12px; color: var(--text-muted); white-space: nowrap; }

        /* Kebab menu */
        .kebab { position: relative; }
        .kebab-btn { width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .15s; font-size: 18px; }
        .kebab-btn:hover { background: rgba(255,255,255,.08); color: var(--text); }
        .kebab-menu { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 6px; min-width: 180px; z-index: 100; box-shadow: 0 8px 24px rgba(0,0,0,.3); }
        .kebab-menu.open { display: block; animation: menuFade .15s ease; }
        @keyframes menuFade { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
        .menu-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 6px; border: none; background: none; color: var(--text); cursor: pointer; font-size: 13px; width: 100%; text-align: left; transition: background .1s; }
        .menu-item:hover { background: rgba(255,255,255,.06); }
        .menu-item svg { opacity: .5; flex-shrink: 0; }
        .menu-sep { height: 1px; background: var(--border); margin: 4px 0; }
        .menu-item.menu-danger { color: #e74c3c; }
        .menu-item.menu-danger:hover { background: rgba(231,76,60,.1); }

        /* Header row */
        .user-list-header { display: grid; grid-template-columns: 44px 1fr 1fr auto auto auto 40px; gap: 16px; padding: 8px 16px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; font-weight: 600; border-bottom: 1px solid var(--border); margin-bottom: 4px; }

        /* ── MODAL ────────────────────────────────────────── */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.5); backdrop-filter: blur(4px); z-index: 1000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 32px; width: 420px; max-width: 90vw; animation: modalIn .2s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(.95); } to { opacity: 1; transform: scale(1); } }
        .modal-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; font-size: 22px; }
        .modal-icon-plan { background: rgba(46,204,113,.12); color: #2ecc71; }
        .modal-icon-pw { background: rgba(52,152,219,.12); color: #3498db; }
        .modal-icon-del { background: rgba(231,76,60,.12); color: #e74c3c; }
        .modal h3 { margin-bottom: 4px; font-size: 18px; }
        .modal-sub { color: var(--text-muted); font-size: 13px; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }
        .modal .btn { padding: 10px 24px; border-radius: 10px; font-weight: 600; }

        /* ── TOAST ────────────────────────────────────────── */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 24px; border-radius: 12px; color: #fff; font-size: 14px; font-weight: 600; z-index: 2000; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 24px rgba(0,0,0,.2); animation: toastIn .3s ease; }
        .toast-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .toast-error { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        @keyframes toastIn { from { transform: translateY(20px) scale(.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

        /* ── EMPTY STATE ──────────────────────────────────── */
        .empty-state { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        .empty-state svg { opacity: .2; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">BotBlaze</a>
        <ul class="navbar-nav">
            <li><a href="admin.html">Admin</a></li>
            <li><a href="#" id="logout-btn">Sair</a></li>
        </ul>
    </nav>

    <div class="container dashboard">
        <h1>Painel Admin</h1>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="s-users">0</div>
                <div class="stat-label">Usuarios</div>
            </div>
            <div class="stat-card stat-green">
                <div class="stat-value" id="s-subs">0</div>
                <div class="stat-label">Assinantes Ativos</div>
            </div>
            <div class="stat-card stat-gold">
                <div class="stat-value" id="s-revenue">R$ 0</div>
                <div class="stat-label">Receita Total</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="s-bets">0</div>
                <div class="stat-label">Apostas Hoje</div>
            </div>
        </div>

        <!-- Users -->
        <div class="card" style="padding: 24px;">
            <div class="toolbar">
                <div class="filter-dropdown" id="filter-dropdown">
                    <button class="filter-btn" id="filter-btn" onclick="toggleFilterMenu()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/></svg>
                        <span class="filter-btn-label" id="filter-label">Todos</span>
                        <span class="filter-btn-count" id="filter-count">0</span>
                        <svg class="filter-btn-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                    </button>
                    <div class="filter-menu" id="filter-menu">
                        <button class="filter-option active" data-filter="all" onclick="setFilter('all', 'Todos')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            <span class="filter-option-label">Todos</span>
                            <span class="filter-option-count" id="fc-all">0</span>
                        </button>
                        <div class="filter-sep"></div>
                        <button class="filter-option" data-filter="admin" onclick="setFilter('admin', 'Admin')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 15l-2-2m0 0l-2-2m2 2l2-2m-2 2l-2 2"/><path d="M9.75 3.104v5.714a2.25 2.25 0 0 1-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.3 24.3 0 0 1 4.5 0m0 0v5.714a2.25 2.25 0 0 0 .659 1.591L19 14.5m-4.75-11.396c.251.023.501.05.75.082"/></svg>
                            <span class="filter-option-label">Admin</span>
                            <span class="filter-option-count" id="fc-admin">0</span>
                        </button>
                        <button class="filter-option" data-filter="user" onclick="setFilter('user', 'Usuarios')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                            <span class="filter-option-label">Usuarios</span>
                            <span class="filter-option-count" id="fc-user">0</span>
                        </button>
                        <div class="filter-sep"></div>
                        <button class="filter-option" data-filter="active" onclick="setFilter('active', 'Ativos')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
                            <span class="filter-option-label">Ativos</span>
                            <span class="filter-option-count" id="fc-active">0</span>
                        </button>
                        <button class="filter-option" data-filter="blocked" onclick="setFilter('blocked', 'Bloqueados')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>
                            <span class="filter-option-label">Bloqueados</span>
                            <span class="filter-option-count" id="fc-blocked">0</span>
                        </button>
                        <div class="filter-sep"></div>
                        <button class="filter-option" data-filter="with_plan" onclick="setFilter('with_plan', 'Com Plano')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                            <span class="filter-option-label">Com Plano</span>
                            <span class="filter-option-count" id="fc-with_plan">0</span>
                        </button>
                        <button class="filter-option" data-filter="no_plan" onclick="setFilter('no_plan', 'Sem Plano')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg>
                            <span class="filter-option-label">Sem Plano</span>
                            <span class="filter-option-count" id="fc-no_plan">0</span>
                        </button>
                    </div>
                </div>

                <div class="search-wrap">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <input type="text" class="search-field" id="search-input" placeholder="Buscar por nome ou email...">
                </div>
                <span class="result-count" id="user-count"></span>
            </div>

            <div class="user-list-header">
                <span></span>
                <span>Usuario</span>
                <span>Plano</span>
                <span>Status</span>
                <span>Cadastro</span>
                <span></span>
                <span></span>
            </div>
            <div class="user-list" id="users-list">
                <div class="empty-state"><p>Carregando...</p></div>
            </div>
        </div>
    </div>

    <!-- Modal: Atribuir Plano -->
    <div class="modal-overlay" id="modal-plan">
        <div class="modal">
            <div class="modal-icon modal-icon-plan">&#9733;</div>
            <h3>Atribuir Plano</h3>
            <p class="modal-sub">Selecione um plano para <strong id="modal-plan-user"></strong></p>
            <div class="form-group">
                <select id="modal-plan-select" class="form-input"></select>
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('modal-plan')">Cancelar</button>
                <button class="btn btn-primary" id="modal-plan-confirm">Atribuir Plano</button>
            </div>
        </div>
    </div>

    <!-- Modal: Resetar Senha -->
    <div class="modal-overlay" id="modal-password">
        <div class="modal">
            <div class="modal-icon modal-icon-pw">&#128274;</div>
            <h3>Resetar Senha</h3>
            <p class="modal-sub">Nova senha para <strong id="modal-pw-user"></strong></p>
            <div class="form-group">
                <input type="text" id="modal-pw-input" class="form-input" placeholder="Minimo 6 caracteres" minlength="6">
            </div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('modal-password')">Cancelar</button>
                <button class="btn btn-primary" id="modal-pw-confirm">Alterar Senha</button>
            </div>
        </div>
    </div>

    <!-- Modal: Confirmar Exclusao -->
    <div class="modal-overlay" id="modal-delete">
        <div class="modal">
            <div class="modal-icon modal-icon-del">&#9888;</div>
            <h3>Excluir Usuario</h3>
            <p class="modal-sub">Tem certeza que deseja excluir <strong id="modal-del-user"></strong>?<br>Esta acao e irreversivel.</p>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeModal('modal-delete')">Cancelar</button>
                <button class="btn btn-primary" style="background: #e74c3c; border-color: #e74c3c;" id="modal-del-confirm">Excluir</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>BotBlaze Admin &copy; 2026</p>
    </footer>

    <script>
    const API_URL = window.location.origin + '/api';
    const token = localStorage.getItem('botblaze_token');
    const currentUser = JSON.parse(localStorage.getItem('botblaze_user') || '{}');

    if (!token || currentUser.role !== 'admin') window.location.href = '/login.html';

    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('botblaze_token');
        localStorage.removeItem('botblaze_user');
        window.location.href = '/login.html';
    });

    let allUsers = [], allPlans = [], currentFilter = 'all', searchQuery = '';

    // ── FILTER DROPDOWN ──────────────────────────────────────────────────────

    function toggleFilterMenu() {
        const btn = document.getElementById('filter-btn');
        const menu = document.getElementById('filter-menu');
        const isOpen = menu.classList.contains('open');
        closeAllMenus();
        if (!isOpen) {
            menu.classList.add('open');
            btn.classList.add('open');
        }
    }

    function setFilter(filter, label) {
        currentFilter = filter;
        document.getElementById('filter-label').textContent = label;
        document.querySelectorAll('.filter-option').forEach(o => o.classList.toggle('active', o.dataset.filter === filter));
        const countEl = document.getElementById('fc-' + filter);
        document.getElementById('filter-count').textContent = countEl ? countEl.textContent : '0';
        document.getElementById('filter-menu').classList.remove('open');
        document.getElementById('filter-btn').classList.remove('open');
        renderUsers();
    }

    document.getElementById('search-input').addEventListener('input', (e) => {
        searchQuery = e.target.value.toLowerCase();
        renderUsers();
    });

    function filterUsers() {
        let f = allUsers;
        switch (currentFilter) {
            case 'admin':     f = f.filter(u => u.role === 'admin'); break;
            case 'user':      f = f.filter(u => u.role === 'user'); break;
            case 'active':    f = f.filter(u => u.status === 'active'); break;
            case 'blocked':   f = f.filter(u => u.status === 'blocked'); break;
            case 'with_plan': f = f.filter(u => u.plan_name); break;
            case 'no_plan':   f = f.filter(u => !u.plan_name); break;
        }
        if (searchQuery) {
            f = f.filter(u => u.name.toLowerCase().includes(searchQuery) || u.email.toLowerCase().includes(searchQuery));
        }
        return f;
    }

    function updateCounts() {
        document.getElementById('fc-all').textContent = allUsers.length;
        document.getElementById('fc-admin').textContent = allUsers.filter(u => u.role === 'admin').length;
        document.getElementById('fc-user').textContent = allUsers.filter(u => u.role === 'user').length;
        document.getElementById('fc-active').textContent = allUsers.filter(u => u.status === 'active').length;
        document.getElementById('fc-blocked').textContent = allUsers.filter(u => u.status === 'blocked').length;
        document.getElementById('fc-with_plan').textContent = allUsers.filter(u => u.plan_name).length;
        document.getElementById('fc-no_plan').textContent = allUsers.filter(u => !u.plan_name).length;
        // Sync filter button count
        const countEl = document.getElementById('fc-' + currentFilter);
        if (countEl) document.getElementById('filter-count').textContent = countEl.textContent;
    }

    // ── RENDER ───────────────────────────────────────────────────────────────

    function renderUsers() {
        const filtered = filterUsers();
        const container = document.getElementById('users-list');
        document.getElementById('user-count').textContent = filtered.length + ' de ' + allUsers.length;

        if (!filtered.length) {
            container.innerHTML = '<div class="empty-state"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="7" r="4"/><path d="M5.5 21a6.5 6.5 0 0 1 13 0"/></svg><p>Nenhum usuario encontrado</p></div>';
            return;
        }

        container.innerHTML = filtered.map(u => {
            const isAdmin = u.role === 'admin';
            const isMe = u.id == currentUser.id;
            const initials = u.name.split(' ').map(w => w[0]).join('').substring(0, 2);
            const avatarClass = isAdmin ? 'avatar-admin' : 'avatar-user';
            const rowClass = isAdmin ? 'is-admin' : '';

            const nameExtra = isAdmin ? '<span class="tag tag-admin">Admin</span>' : '';
            const youTag = isMe ? '<span class="tag tag-you">Voce</span>' : '';

            const statusClass = u.status === 'active' ? 'status-active' : 'status-blocked';
            const statusText = u.status === 'active' ? 'Ativo' : 'Bloqueado';

            let planHtml;
            if (u.plan_name) {
                const expDate = new Date(u.expires_at).toLocaleDateString('pt-BR');
                planHtml = `<div class="plan-info"><div class="plan-name">${u.plan_name}</div><div class="plan-expires">Expira ${expDate}</div></div>`;
            } else {
                planHtml = '<div class="plan-none">Sem plano</div>';
            }

            const created = new Date(u.created_at).toLocaleDateString('pt-BR');

            // Escape name for onclick
            const safeName = u.name.replace(/'/g, "\\'");

            // Menu items
            let menuItems = '';
            if (!isMe) {
                const blockIcon = u.status === 'active'
                    ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>'
                    : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>';
                const blockText = u.status === 'active' ? 'Bloquear' : 'Desbloquear';

                const planIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>';
                const planText = u.plan_name ? 'Trocar Plano' : 'Atribuir Plano';

                menuItems = `
                    <button class="menu-item" onclick="toggleStatus(${u.id}); closeAllMenus();">${blockIcon} ${blockText}</button>
                    <button class="menu-item" onclick="openPlanModal(${u.id}, '${safeName}'); closeAllMenus();">${planIcon} ${planText}</button>
                    ${u.plan_name ? '<button class="menu-item" onclick="removePlan(' + u.id + '); closeAllMenus();"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18M6 6l12 12"/></svg> Remover Plano</button>' : ''}
                    <button class="menu-item" onclick="openPasswordModal(${u.id}, '${safeName}'); closeAllMenus();"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Resetar Senha</button>
                    <div class="menu-sep"></div>
                    <button class="menu-item menu-danger" onclick="openDeleteModal(${u.id}, '${safeName}'); closeAllMenus();"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Excluir Usuario</button>
                `;
            }

            const kebab = isMe ? '' : `
                <div class="kebab">
                    <button class="kebab-btn" onclick="toggleMenu(event, this)">&#8942;</button>
                    <div class="kebab-menu">${menuItems}</div>
                </div>`;

            return `<div class="user-row ${rowClass}">
                <div class="avatar ${avatarClass}">${initials}</div>
                <div class="user-info">
                    <div class="user-name">${u.name} ${nameExtra} ${youTag}</div>
                    <div class="user-email">${u.email}</div>
                </div>
                ${planHtml}
                <div class="status-dot ${statusClass}">${statusText}</div>
                <div class="date-cell">${created}</div>
                <div></div>
                ${kebab}
            </div>`;
        }).join('');
    }

    // ── KEBAB MENU ───────────────────────────────────────────────────────────

    function toggleMenu(e, btn) {
        e.stopPropagation();
        const menu = btn.nextElementSibling;
        const wasOpen = menu.classList.contains('open');
        closeAllMenus();
        if (!wasOpen) menu.classList.add('open');
    }

    function closeAllMenus() {
        document.querySelectorAll('.kebab-menu.open').forEach(m => m.classList.remove('open'));
        document.getElementById('filter-menu').classList.remove('open');
        document.getElementById('filter-btn').classList.remove('open');
    }

    document.addEventListener('click', closeAllMenus);

    // ── API CALLS ────────────────────────────────────────────────────────────

    async function adminAction(action, data) {
        try {
            const res = await fetch(API_URL + '/admin.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ action, ...data })
            });
            const result = await res.json();
            if (result.error) { showToast(result.error, 'error'); return false; }
            showToast(result.message || 'Sucesso!', 'success');
            return true;
        } catch (err) { showToast('Erro de conexao', 'error'); return false; }
    }

    async function toggleStatus(id) { if (await adminAction('toggle_status', { user_id: id })) loadAdmin(); }
    async function removePlan(id) { if (await adminAction('remove_plan', { user_id: id })) loadAdmin(); }

    // ── MODALS ───────────────────────────────────────────────────────────────

    let modalTargetId = null;

    function openPlanModal(id, name) {
        modalTargetId = id;
        document.getElementById('modal-plan-user').textContent = name;
        const select = document.getElementById('modal-plan-select');
        select.innerHTML = allPlans.map(p => `<option value="${p.id}">${p.name} - R$ ${parseFloat(p.price).toFixed(2).replace('.',',')} (${p.duration_days} dias)</option>`).join('');
        document.getElementById('modal-plan').classList.add('show');
    }

    document.getElementById('modal-plan-confirm').addEventListener('click', async () => {
        const planId = document.getElementById('modal-plan-select').value;
        closeModal('modal-plan');
        if (await adminAction('set_plan', { user_id: modalTargetId, plan_id: parseInt(planId) })) loadAdmin();
    });

    function openPasswordModal(id, name) {
        modalTargetId = id;
        document.getElementById('modal-pw-user').textContent = name;
        document.getElementById('modal-pw-input').value = '';
        document.getElementById('modal-password').classList.add('show');
    }

    document.getElementById('modal-pw-confirm').addEventListener('click', async () => {
        const pw = document.getElementById('modal-pw-input').value;
        if (pw.length < 6) { showToast('Senha deve ter no minimo 6 caracteres', 'error'); return; }
        closeModal('modal-password');
        if (await adminAction('reset_password', { user_id: modalTargetId, new_password: pw })) loadAdmin();
    });

    function openDeleteModal(id, name) {
        modalTargetId = id;
        document.getElementById('modal-del-user').textContent = name;
        document.getElementById('modal-delete').classList.add('show');
    }

    document.getElementById('modal-del-confirm').addEventListener('click', async () => {
        closeModal('modal-delete');
        if (await adminAction('delete_user', { user_id: modalTargetId })) loadAdmin();
    });

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    document.querySelectorAll('.modal-overlay').forEach(o => {
        o.addEventListener('click', (e) => { if (e.target === o) o.classList.remove('show'); });
    });

    // ── TOAST ────────────────────────────────────────────────────────────────

    function showToast(msg, type) {
        const icon = type === 'success' ? '&#10003;' : '&#10007;';
        const el = document.createElement('div');
        el.className = 'toast toast-' + type;
        el.innerHTML = '<span>' + icon + '</span> ' + msg;
        document.body.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(10px)'; setTimeout(() => el.remove(), 300); }, 2500);
    }

    // ── LOAD ─────────────────────────────────────────────────────────────────

    async function loadAdmin() {
        try {
            const res = await fetch(API_URL + '/admin.php', { headers: { 'Authorization': 'Bearer ' + token } });
            const data = await res.json();
            if (data.error) { window.location.href = '/login.html'; return; }

            const s = data.stats;
            document.getElementById('s-users').textContent = s.total_users;
            document.getElementById('s-subs').textContent = s.active_subs;
            document.getElementById('s-revenue').textContent = 'R$ ' + parseFloat(s.revenue).toFixed(2).replace('.', ',');
            document.getElementById('s-bets').textContent = s.today_bets;

            allUsers = data.users || [];
            allPlans = data.plans || [];
            updateCounts();
            renderUsers();
        } catch (err) { console.error('Erro:', err); }
    }

    loadAdmin();
    setInterval(loadAdmin, 30000);
    </script>
</body>
</html>
