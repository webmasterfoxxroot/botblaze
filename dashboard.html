<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BotBlaze</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ── GREETING ────────────────────────────────────── */
        .greeting { margin-bottom: 28px; }
        .greeting h1 { font-size: 26px; font-weight: 800; margin-bottom: 4px; }
        .greeting p { color: var(--text-muted); font-size: 14px; }

        /* ── SUB CARD ────────────────────────────────────── */
        .sub-card { display: flex; align-items: center; gap: 20px; padding: 20px 24px; border-radius: 14px; margin-bottom: 24px; }
        .sub-card-active { background: linear-gradient(135deg, rgba(46,204,113,.08), rgba(46,204,113,.02)); border: 1px solid rgba(46,204,113,.2); }
        .sub-card-none { background: linear-gradient(135deg, rgba(210,153,34,.08), rgba(210,153,34,.02)); border: 1px solid rgba(210,153,34,.2); }
        .sub-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .sub-icon-active { background: rgba(46,204,113,.15); color: #2ecc71; }
        .sub-icon-none { background: rgba(210,153,34,.15); color: #d29922; }
        .sub-info { flex: 1; min-width: 0; }
        .sub-info h3 { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
        .sub-info p { font-size: 13px; color: var(--text-muted); }
        .sub-badge { padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 700; white-space: nowrap; }
        .sub-badge-active { background: rgba(46,204,113,.15); color: #2ecc71; }
        .sub-badge-none { background: rgba(210,153,34,.15); color: #d29922; }

        /* ── STAT CARDS (enhanced) ───────────────────────── */
        .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 24px; }
        .s-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 18px; display: flex; align-items: flex-start; gap: 14px; transition: border-color .2s; }
        .s-card:hover { border-color: rgba(255,255,255,.1); }
        .s-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .s-icon svg { width: 20px; height: 20px; }
        .s-icon-default { background: rgba(255,255,255,.06); color: var(--text-muted); }
        .s-icon-green { background: rgba(46,204,113,.12); color: #2ecc71; }
        .s-icon-red { background: rgba(248,81,73,.12); color: #f85149; }
        .s-icon-gold { background: rgba(210,153,34,.12); color: #d29922; }
        .s-icon-blue { background: rgba(88,166,255,.12); color: #58a6ff; }
        .s-data {}
        .s-value { font-size: 22px; font-weight: 800; line-height: 1.2; }
        .s-label { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        .s-value-green { color: var(--green); }
        .s-value-red { color: var(--red); }
        .s-value-gold { color: var(--gold); }

        /* ── SECTION HEADER ──────────────────────────────── */
        .section-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .section-head h2 { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .section-head h2 svg { opacity: .4; }
        .tab-row { display: flex; gap: 4px; }
        .tab-btn { padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); cursor: pointer; font-size: 12px; font-weight: 600; transition: all .15s; }
        .tab-btn:hover { color: var(--text); border-color: rgba(255,255,255,.15); }
        .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* ── BET HISTORY TABLE ────────────────────────────── */
        .hist-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 24px; }
        .hist-card .section-head { padding: 18px 20px 0; }
        .hist-table { width: 100%; border-collapse: collapse; }
        .hist-table th { padding: 10px 16px; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; color: var(--text-muted); font-weight: 600; text-align: left; border-bottom: 1px solid var(--border); }
        .hist-table td { padding: 12px 16px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,.03); }
        .hist-table tr:last-child td { border-bottom: none; }
        .hist-table tr:hover td { background: rgba(255,255,255,.02); }

        .color-badge { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .color-badge-1 { background: rgba(230,57,70,.12); color: #e63946; }
        .color-badge-2 { background: rgba(255,255,255,.06); color: var(--text-muted); }
        .color-badge-0 { background: rgba(255,255,255,.12); color: #f0f0f0; }
        .color-badge::before { content: ''; width: 8px; height: 8px; border-radius: 50%; }
        .color-badge-1::before { background: #e63946; }
        .color-badge-2::before { background: #444; }
        .color-badge-0::before { background: #f0f0f0; }

        .result-badge { padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: .3px; }
        .result-win { background: rgba(46,204,113,.12); color: #2ecc71; }
        .result-loss { background: rgba(248,81,73,.12); color: #f85149; }
        .result-pending { background: rgba(210,153,34,.12); color: #d29922; }

        .profit-pos { color: var(--green); font-weight: 600; }
        .profit-neg { color: var(--red); font-weight: 600; }
        .mg-badge { padding: 2px 8px; border-radius: 6px; font-size: 11px; background: rgba(88,166,255,.1); color: var(--blue); font-weight: 600; }

        .empty-hist { text-align: center; padding: 48px 24px; color: var(--text-muted); }
        .empty-hist svg { opacity: .15; margin-bottom: 12px; }
        .empty-hist p { font-size: 14px; }

        /* ── EXTENSION CARD ──────────────────────────────── */
        .ext-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; position: relative; overflow: hidden; }
        .ext-card-locked { opacity: .7; }
        .ext-card-locked::after { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,.3); border-radius: 12px; pointer-events: none; }

        .ext-download-area { display: flex; align-items: center; gap: 20px; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(46,204,113,.06), rgba(46,204,113,.02)); border: 1px solid rgba(46,204,113,.15); border-radius: 12px; }
        .ext-download-icon { width: 56px; height: 56px; border-radius: 14px; background: rgba(46,204,113,.12); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .ext-download-info { flex: 1; min-width: 0; }
        .ext-download-info h4 { font-size: 15px; font-weight: 700; margin-bottom: 4px; color: var(--text); }
        .ext-download-info p { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
        .ext-download-btn { padding: 12px 24px; border-radius: 10px; border: none; background: linear-gradient(135deg, #2ecc71, #27ae60); color: #fff; cursor: pointer; font-size: 14px; font-weight: 700; display: inline-flex; align-items: center; gap: 8px; transition: all .2s; flex-shrink: 0; box-shadow: 0 4px 16px rgba(46,204,113,.25); }
        .ext-download-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(46,204,113,.35); }
        .ext-download-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
        .ext-download-btn svg { width: 18px; height: 18px; }

        .ext-steps { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-top: 16px; }
        .ext-step { background: rgba(255,255,255,.02); border: 1px solid var(--border); border-radius: 10px; padding: 16px; text-align: center; }
        .ext-step-num { width: 28px; height: 28px; border-radius: 8px; background: var(--accent); color: #fff; font-size: 13px; font-weight: 700; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 8px; }
        .ext-step p { font-size: 12px; color: var(--text-muted); line-height: 1.4; }
        .ext-step strong { color: var(--text); }

        .ext-locked-msg { display: flex; align-items: center; gap: 16px; margin-top: 16px; padding: 18px 20px; background: rgba(210,153,34,.06); border: 1px solid rgba(210,153,34,.15); border-radius: 12px; }
        .ext-locked-icon { width: 44px; height: 44px; border-radius: 12px; background: rgba(210,153,34,.12); display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: #d29922; }
        .ext-locked-text { flex: 1; }
        .ext-locked-text p { font-size: 13px; color: var(--text-muted); line-height: 1.5; }
        .ext-locked-text a { color: #d29922; font-weight: 600; text-decoration: none; }
        .ext-locked-text a:hover { text-decoration: underline; }

        .token-row { display: flex; align-items: center; gap: 10px; margin-top: 16px; padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 10px; }
        .token-row code { flex: 1; font-size: 12px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .token-row button { padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border); background: transparent; color: var(--text); cursor: pointer; font-size: 12px; font-weight: 600; transition: all .15s; flex-shrink: 0; }
        .token-row button:hover { border-color: var(--accent); color: var(--accent); }

        /* ── TOAST ────────────────────────────────────────── */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 12px 20px; border-radius: 10px; color: #fff; font-size: 13px; font-weight: 600; z-index: 2000; display: flex; align-items: center; gap: 8px; box-shadow: 0 8px 24px rgba(0,0,0,.2); animation: toastIn .3s ease; }
        .toast-success { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        @keyframes toastIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        @media (max-width: 768px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .ext-steps { grid-template-columns: 1fr; }
            .sub-card { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/" class="navbar-brand">BotBlaze</a>
        <ul class="navbar-nav">
            <li><a href="dashboard.html">Dashboard</a></li>
            <li><a href="settings.html">Configuracoes</a></li>
            <li id="admin-link" style="display:none;"><a href="admin.html">Admin</a></li>
            <li><a href="#" id="logout-btn">Sair</a></li>
        </ul>
    </nav>

    <div class="container dashboard">
        <!-- Greeting -->
        <div class="greeting">
            <h1 id="greeting-text">Ola!</h1>
            <p>Acompanhe seus resultados e gerencie o bot</p>
        </div>

        <!-- Subscription Status -->
        <div id="sub-card"></div>

        <!-- Stats -->
        <div class="section-head">
            <h2>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                Estatisticas
            </h2>
            <div class="tab-row">
                <button class="tab-btn active" onclick="switchStats('today')">Hoje</button>
                <button class="tab-btn" onclick="switchStats('all')">Total</button>
            </div>
        </div>
        <div class="stats-row" id="stats-row">
            <div class="s-card">
                <div class="s-icon s-icon-default"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg></div>
                <div class="s-data"><div class="s-value" id="st-total">0</div><div class="s-label">Apostas</div></div>
            </div>
            <div class="s-card">
                <div class="s-icon s-icon-green"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg></div>
                <div class="s-data"><div class="s-value s-value-green" id="st-wins">0</div><div class="s-label">Vitorias</div></div>
            </div>
            <div class="s-card">
                <div class="s-icon s-icon-red"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg></div>
                <div class="s-data"><div class="s-value s-value-red" id="st-losses">0</div><div class="s-label">Derrotas</div></div>
            </div>
            <div class="s-card">
                <div class="s-icon s-icon-gold"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                <div class="s-data"><div class="s-value s-value-gold" id="st-profit">R$ 0,00</div><div class="s-label">Lucro</div></div>
            </div>
            <div class="s-card">
                <div class="s-icon s-icon-blue"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
                <div class="s-data"><div class="s-value" id="st-winrate">0%</div><div class="s-label">Win Rate</div></div>
            </div>
        </div>

        <!-- Bet History -->
        <div class="hist-card">
            <div class="section-head">
                <h2>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                    Historico de Apostas
                </h2>
            </div>
            <table class="hist-table">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Cor</th>
                        <th>Valor</th>
                        <th>Resultado</th>
                        <th>Lucro</th>
                        <th>Martingale</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    <tr><td colspan="6"><div class="empty-hist">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        <p>Nenhuma aposta registrada</p>
                    </div></td></tr>
                </tbody>
            </table>
        </div>

        <!-- Extension Section -->
        <div class="ext-card" id="ext-card">
            <div class="section-head" style="margin-bottom:0;">
                <h2>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 2H7a5 5 0 0 0-5 5v10a5 5 0 0 0 5 5h10a5 5 0 0 0 5-5V7a5 5 0 0 0-5-5Z"/><path d="M12 8v8m-4-4h8"/></svg>
                    Extensao Chrome
                </h2>
                <span id="ext-version" style="font-size:12px; color:var(--text-muted);">v1.0.0</span>
            </div>

            <!-- Area de download (visivel apenas com plano ativo) -->
            <div id="ext-active-area" style="display:none;">
                <div class="ext-download-area">
                    <div class="ext-download-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#2ecc71" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </div>
                    <div class="ext-download-info">
                        <h4>Baixar Extensao Personalizada</h4>
                        <p>Sua extensao ja vem configurada com seu token e plano <strong id="ext-plan-name">---</strong> ativo. So instalar e usar!</p>
                    </div>
                    <button class="ext-download-btn" id="btn-download-ext" onclick="downloadExtension()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Baixar
                    </button>
                </div>

                <div class="ext-steps">
                    <div class="ext-step">
                        <div class="ext-step-num">1</div>
                        <p>Clique em <strong>Baixar</strong> e extraia o ZIP</p>
                    </div>
                    <div class="ext-step">
                        <div class="ext-step-num">2</div>
                        <p>Abra <strong>chrome://extensions</strong> e ative o <strong>Modo Desenvolvedor</strong></p>
                    </div>
                    <div class="ext-step">
                        <div class="ext-step-num">3</div>
                        <p>Clique <strong>Carregar sem compactacao</strong> e selecione a pasta extraida</p>
                    </div>
                </div>

                <div class="token-row">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity:.4;flex-shrink:0;"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    <code id="api-token">---</code>
                    <button onclick="copyToken()">Copiar Token</button>
                </div>
            </div>

            <!-- Area bloqueada (visivel sem plano) -->
            <div id="ext-locked-area" style="display:none;">
                <div class="ext-locked-msg">
                    <div class="ext-locked-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    </div>
                    <div class="ext-locked-text">
                        <p>A extensao Chrome so fica disponivel com um <strong>plano ativo</strong>. Assine e receba sua extensao personalizada, ja configurada com seu acesso.</p>
                        <a href="index.html#plans">Ver Planos &rarr;</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>BotBlaze &copy; 2026</p>
    </footer>

    <script>
    const API_URL = window.location.origin + '/api';
    const token = localStorage.getItem('botblaze_token');
    const user = JSON.parse(localStorage.getItem('botblaze_user') || '{}');

    if (!token) window.location.href = '/login.html';

    // Show admin link if admin
    if (user.role === 'admin') document.getElementById('admin-link').style.display = '';

    // Greeting based on time of day
    const hour = new Date().getHours();
    let greetWord = 'Boa noite';
    if (hour >= 5 && hour < 12) greetWord = 'Bom dia';
    else if (hour >= 12 && hour < 18) greetWord = 'Boa tarde';
    document.getElementById('greeting-text').textContent = greetWord + ', ' + (user.name || 'Usuario') + '!';

    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('botblaze_token');
        localStorage.removeItem('botblaze_user');
        window.location.href = '/login.html';
    });

    // ── DATA ────────────────────────────────────────────────────────────────────
    let histData = null, statsView = 'today';

    const colorNames = { 0: 'Branco', 1: 'Vermelho', 2: 'Preto' };

    function copyToken() {
        const t = document.getElementById('api-token').textContent;
        if (t && t !== '---') {
            navigator.clipboard.writeText(t).then(() => showToast('Token copiado!'));
        }
    }

    function downloadExtension() {
        const btn = document.getElementById('btn-download-ext');
        btn.disabled = true;
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20"/><path d="M2 12l10 10 10-10"/></svg> Baixando...';

        // Download direto via link com token na URL
        const downloadUrl = API_URL + '/extension.php?token=' + encodeURIComponent(token);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'BotBlaze-Extension.zip';
        document.body.appendChild(a);
        a.click();
        a.remove();
        showToast('Download iniciado!');

        setTimeout(() => {
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Baixar';
        }, 2000);
    }

    function showToast(msg) {
        const el = document.createElement('div');
        el.className = 'toast toast-success';
        el.innerHTML = '&#10003; ' + msg;
        document.body.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 2000);
    }

    // ── STATS SWITCH ────────────────────────────────────────────────────────────
    function switchStats(view) {
        statsView = view;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.textContent.trim() === (view === 'today' ? 'Hoje' : 'Total')));
        renderStats();
    }

    function renderStats() {
        if (!histData) return;
        const s = statsView === 'today' ? histData.today : histData.stats;
        if (!s) return;

        const total = s.total_bets || 0;
        const wins = s.wins || 0;
        const losses = s.losses || 0;
        const profit = parseFloat(s.profit) || 0;
        const decided = wins + losses;
        const winrate = decided > 0 ? ((wins / decided) * 100).toFixed(1) : '0';

        document.getElementById('st-total').textContent = total;
        document.getElementById('st-wins').textContent = wins;
        document.getElementById('st-losses').textContent = losses;
        document.getElementById('st-profit').textContent = (profit >= 0 ? '+' : '') + 'R$ ' + profit.toFixed(2).replace('.', ',');
        document.getElementById('st-winrate').textContent = winrate + '%';
    }

    // ── RENDER HISTORY ──────────────────────────────────────────────────────────
    function renderHistory() {
        if (!histData || !histData.bets || !histData.bets.length) return;
        const tbody = document.getElementById('history-body');
        tbody.innerHTML = histData.bets.slice(0, 50).map(b => {
            const color = parseInt(b.color_bet);
            const time = new Date(b.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const profit = parseFloat(b.profit) || 0;
            const resultClass = b.result === 'win' ? 'result-win' : (b.result === 'loss' ? 'result-loss' : 'result-pending');
            const resultText = b.result === 'win' ? 'WIN' : (b.result === 'loss' ? 'LOSS' : '...');
            const profitClass = profit >= 0 ? 'profit-pos' : 'profit-neg';
            const mgHtml = b.was_martingale ? '<span class="mg-badge">Nv ' + b.martingale_level + '</span>' : '<span style="color:var(--text-muted)">-</span>';
            return `<tr>
                <td>${time}</td>
                <td><span class="color-badge color-badge-${color}">${colorNames[color] || '?'}</span></td>
                <td>R$ ${parseFloat(b.amount).toFixed(2).replace('.',',')}</td>
                <td><span class="result-badge ${resultClass}">${resultText}</span></td>
                <td class="${profitClass}">${profit >= 0 ? '+' : ''}R$ ${profit.toFixed(2).replace('.',',')}</td>
                <td>${mgHtml}</td>
            </tr>`;
        }).join('');
    }

    // ── RENDER SUBSCRIPTION ─────────────────────────────────────────────────────
    function renderSubscription(subData) {
        const card = document.getElementById('sub-card');
        const extActiveArea = document.getElementById('ext-active-area');
        const extLockedArea = document.getElementById('ext-locked-area');

        if (subData.subscription) {
            const s = subData.subscription;
            const days = s.days_remaining;
            card.innerHTML = `<div class="sub-card sub-card-active">
                <div class="sub-icon sub-icon-active">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                </div>
                <div class="sub-info">
                    <h3>Plano ${s.plan_name}</h3>
                    <p>Expira em ${new Date(s.expires_at).toLocaleDateString('pt-BR')} (${days} dia${days !== 1 ? 's' : ''})</p>
                </div>
                <span class="sub-badge sub-badge-active">Ativo</span>
            </div>`;

            // Mostra area de download da extensao
            extActiveArea.style.display = '';
            extLockedArea.style.display = 'none';
            document.getElementById('ext-card').classList.remove('ext-card-locked');

            // Atualiza nome do plano no card de download
            const planEl = document.getElementById('ext-plan-name');
            if (planEl) planEl.textContent = s.plan_name;
        } else {
            card.innerHTML = `<div class="sub-card sub-card-none">
                <div class="sub-icon sub-icon-none">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                </div>
                <div class="sub-info">
                    <h3>Sem assinatura ativa</h3>
                    <p>Escolha um plano para ativar a extensao e comecar a apostar</p>
                </div>
                <a href="index.html#plans" class="btn btn-primary btn-sm">Ver Planos</a>
            </div>`;

            // Mostra area bloqueada da extensao
            extActiveArea.style.display = 'none';
            extLockedArea.style.display = '';
            document.getElementById('ext-card').classList.add('ext-card-locked');
        }

        if (subData.api_token) {
            document.getElementById('api-token').textContent = subData.api_token;
        }
    }

    // ── LOAD ────────────────────────────────────────────────────────────────────
    async function loadDashboard() {
        try {
            const [subRes, histRes] = await Promise.all([
                fetch(API_URL + '/subscription.php', { headers: { 'Authorization': 'Bearer ' + token } }),
                fetch(API_URL + '/history.php', { headers: { 'Authorization': 'Bearer ' + token } })
            ]);
            const subData = await subRes.json();
            const histResult = await histRes.json();

            renderSubscription(subData);

            if (!histResult.error) {
                histData = histResult;
                renderStats();
                renderHistory();
            }
        } catch (err) { console.error('Erro:', err); }
    }

    loadDashboard();
    setInterval(loadDashboard, 15000);
    </script>
</body>
</html>
